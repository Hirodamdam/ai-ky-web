[1mdiff --git a/app/api/ky-create/route.ts b/app/api/ky-create/route.ts[m
[1mindex 2ad501c..8a90c15 100644[m
[1m--- a/app/api/ky-create/route.ts[m
[1m+++ b/app/api/ky-create/route.ts[m
[36m@@ -2,6 +2,25 @@[m
 import { NextResponse } from "next/server";[m
 import { createClient } from "@supabase/supabase-js";[m
 [m
[32m+[m[32mexport const runtime = "nodejs";[m
[32m+[m
[32m+[m[32mfunction s(v: any) {[m
[32m+[m[32m  return v == null ? "" : String(v);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction pick(src: Record<string, any>, keys: string[]) {[m
[32m+[m[32m  const out: Record<string, any> = {};[m
[32m+[m[32m  for (const k of keys) if (k in src) out[k] = src[k];[m
[32m+[m[32m  return out;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction isValidUuid(v: unknown): v is string {[m
[32m+[m[32m  if (typeof v !== "string") return false;[m
[32m+[m[32m  const x = v.trim();[m
[32m+[m[32m  if (!x || x === "undefined") return false;[m
[32m+[m[32m  return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(x);[m
[32m+[m[32m}[m
[32m+[m
 export async function POST(req: Request) {[m
   try {[m
     const auth = req.headers.get("authorization") || "";[m
[36m@@ -22,7 +41,7 @@[m [mexport async function POST(req: Request) {[m
       );[m
     }[m
 [m
[31m-    // âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ¤œè¨¼ï¼ˆãªã‚Šã™ã¾ã—é˜²æ­¢ï¼‰[m
[32m+[m[32m    // âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼ï¼ˆãªã‚Šã™ã¾ã—é˜²æ­¢ï¼‰[m
     const authed = createClient(url, anonKey, {[m
       global: { headers: { Authorization: `Bearer ${accessToken}` } },[m
     });[m
[36m@@ -31,17 +50,77 @@[m [mexport async function POST(req: Request) {[m
       return NextResponse.json({ error: "Invalid session" }, { status: 401 });[m
     }[m
 [m
[31m-    const body = await req.json();[m
[32m+[m[32m    const body = (await req.json().catch(() => ({}))) as Record<string, any>;[m
[32m+[m
[32m+[m[32m    const project_id = s(body.project_id || body.projectId).trim();[m
[32m+[m[32m    if (!isValidUuid(project_id)) {[m
[32m+[m[32m      return NextResponse.json({ error: "project_id required (uuid)" }, { status: 400 });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // âœ… è¨±å¯ã‚­ãƒ¼ã®ã¿DBã«å…¥ã‚Œã‚‹ï¼ˆã‚´ãƒŸæ··å…¥é˜²æ­¢ï¼‰[m
[32m+[m[32m    const allowed = [[m
[32m+[m[32m      "project_id",[m
[32m+[m[32m      "work_date",[m
[32m+[m[32m      "partner_company_id",[m
[32m+[m[32m      "partner_company_name",[m
[32m+[m[32m      "worker_count",[m
[32m+[m
[32m+[m[32m      // äººã®å…¥åŠ›[m
[32m+[m[32m      "work_content",[m
[32m+[m[32m      "hazards",[m
[32m+[m[32m      "countermeasures",[m
[32m+[m[32m      "third_party_level",[m
[32m+[m
[32m+[m[32m      // æ°—è±¡[m
[32m+[m[32m      "weather_slots",[m
[32m+[m[32m      "weather_applied_slots",[m
[32m+[m[32m      "weather_applied_at",[m
[32m+[m
[32m+[m[32m      // å†™çœŸã‚¹ã‚³ã‚¢ãªã©ï¼ˆå°†æ¥ç”¨ï¼‰[m
[32m+[m[32m      "photo_urls",[m
[32m+[m[32m      "photo_score",[m
[32m+[m[32m      "photo_score_detail",[m
[32m+[m
[32m+[m[32m      // ãƒªã‚¹ã‚¯è©•ä¾¡[m
[32m+[m[32m      "risk_score_total",[m
[32m+[m[32m      "risk_score_breakdown",[m
[32m+[m
[32m+[m[32m      // AIï¼ˆäº’æ›ï¼‰[m
[32m+[m[32m      "ai_work_detail",[m
[32m+[m[32m      "ai_hazards",[m
[32m+[m[32m      "ai_countermeasures",[m
[32m+[m[32m      "ai_third_party",[m
[32m+[m[32m      "ai_supplement",[m
[32m+[m
[32m+[m[32m      // âœ… AIæ­£æœ¬[m
[32m+[m[32m      "ai_risk_items",[m
[32m+[m[32m      "ai_profile",[m
[32m+[m[32m      "ai_generated_at",[m
[32m+[m[32m    ];[m
[32m+[m
[32m+[m[32m    const payload = pick(body, allowed);[m
[32m+[m[32m    payload.project_id = project_id;[m
[32m+[m
[32m+[m[32m    const nowIso = new Date().toISOString();[m
[32m+[m[32m    if (!payload.ai_profile) payload.ai_profile = "strict";[m
[32m+[m[32m    if (payload.ai_risk_items && !payload.ai_generated_at) payload.ai_generated_at = nowIso;[m
 [m
[31m-    // âœ… Service Role ã§ä¿å­˜ï¼ˆRLS/401ã‚’å›é¿ï¼‰[m
     const admin = createClient(url, serviceKey);[m
[31m-    const { error } = await admin.from("ky_entries").insert(body);[m
[32m+[m
[32m+[m[32m    const { data, error } = await admin[m
[32m+[m[32m      .from("ky_entries")[m
[32m+[m[32m      .insert(payload)[m
[32m+[m[32m      .select("id, project_id")[m
[32m+[m[32m      .single();[m
 [m
     if (error) {[m
[31m-      return NextResponse.json({ error: error.message, details: error.details, hint: error.hint, code: error.code }, { status: 500 });[m
[32m+[m[32m      return NextResponse.json([m
[32m+[m[32m        { error: error.message, details: error.details, hint: error.hint, code: error.code },[m
[32m+[m[32m        { status: 500 }[m
[32m+[m[32m      );[m
     }[m
 [m
[31m-    return NextResponse.json({ ok: true });[m
[32m+[m[32m    return NextResponse.json({ ok: true, kyId: data?.id, projectId: data?.project_id });[m
   } catch (e: any) {[m
     return NextResponse.json({ error: e?.message ?? "ky create failed" }, { status: 500 });[m
   }[m
[1mdiff --git a/app/projects/[id]/ky/new/KyNewClient.tsx b/app/projects/[id]/ky/new/KyNewClient.tsx[m
[1mindex ad19e4c..1b47b05 100644[m
[1m--- a/app/projects/[id]/ky/new/KyNewClient.tsx[m
[1m+++ b/app/projects/[id]/ky/new/KyNewClient.tsx[m
[36m@@ -31,6 +31,14 @@[m [mtype Project = {[m
 [m
 type PartnerOption = { value: string; name: string };[m
 [m
[32m+[m[32mtype RiskItem = {[m
[32m+[m[32m  rank: number;[m
[32m+[m[32m  hazard: string;[m
[32m+[m[32m  countermeasure: string;[m
[32m+[m[32m  score?: number;[m
[32m+[m[32m  tags?: string[];[m
[32m+[m[32m};[m
[32m+[m
 function s(v: any) {[m
   if (v == null) return "";[m
   return String(v);[m
[36m@@ -58,71 +66,11 @@[m [mfunction degToDirJp(deg: number | null | undefined): string {[m
   return dirs[idx];[m
 }[m
 [m
[31m-function normalizeText(text: string): string {[m
[31m-  return (text || "").replace(/\r\n/g, "\n").replace(/\u3000/g, " ").trim();[m
[31m-}[m
[31m-[m
[31m-function splitAiCombined(text: string): { work: string; hazards: string; countermeasures: string; third: string } {[m
[31m-  const src = (text || "").trim();[m
[31m-  if (!src) return { work: "", hazards: "", countermeasures: "", third: "" };[m
[31m-[m
[31m-  const makeBracketRe = (label: string) =>[m
[31m-    new RegExp(String.raw`(?:^|\n)\s*(?:[â€¢ãƒ»\-*]\s*)?[ã€\[]\s*AIè£œè¶³\s*[ï½œ|]\s*${label}\s*[ã€‘\]]`, "g");[m
[31m-[m
[31m-  const headings: Array<{ key: "work" | "hazards" | "countermeasures" | "third"; re: RegExp }> = [[m
[31m-    { key: "work", re: makeBracketRe("ä½œæ¥­å†…å®¹") },[m
[31m-    { key: "hazards", re: makeBracketRe("å±é™ºäºˆçŸ¥") },[m
[31m-    { key: "countermeasures", re: makeBracketRe("å¯¾ç­–") },[m
[31m-    { key: "third", re: makeBracketRe("ç¬¬ä¸‰è€…(?:\\s*ï¼ˆ\\s*å¢“å‚è€…\\s*ï¼‰)?") },[m
[31m-    { key: "work", re: /(?:^|\n)\s*(ä½œæ¥­å†…å®¹)\s*[:ï¼š]/g },[m
[31m-    { key: "hazards", re: /(?:^|\n)\s*(å±é™ºäºˆçŸ¥)\s*[:ï¼š]/g },[m
[31m-    { key: "countermeasures", re: /(?:^|\n)\s*(å¯¾ç­–)\s*[:ï¼š]/g },[m
[31m-    { key: "third", re: /(?:^|\n)\s*(ç¬¬ä¸‰è€…|å¢“å‚è€…)\s*[:ï¼š]/g },[m
[31m-  ];[m
[31m-[m
[31m-  const marks: Array<{ idx: number; key: "work" | "hazards" | "countermeasures" | "third"; len: number }> = [];[m
[31m-  for (const h of headings) {[m
[31m-    let m: RegExpExecArray | null;[m
[31m-    h.re.lastIndex = 0;[m
[31m-    while ((m = h.re.exec(src))) marks.push({ idx: m.index, key: h.key, len: m[0].length });[m
[31m-  }[m
[31m-  marks.sort((a, b) => a.idx - b.idx);[m
[31m-[m
[31m-  if (!marks.length) return { work: src, hazards: "", countermeasures: "", third: "" };[m
[31m-[m
[31m-  const out = { work: "", hazards: "", countermeasures: "", third: "" };[m
[31m-  for (let i = 0; i < marks.length; i++) {[m
[31m-    const cur = marks[i];[m
[31m-    const next = marks[i + 1];[m
[31m-    const start = cur.idx + cur.len;[m
[31m-    const end = next ? next.idx : src.length;[m
[31m-    const chunk = src.slice(start, end).trim();[m
[31m-    if (!chunk) continue;[m
[31m-    (out as any)[cur.key] = (out as any)[cur.key] ? `${(out as any)[cur.key]}\n${chunk}` : chunk;[m
[31m-  }[m
[31m-  return out;[m
[31m-}[m
[31m-[m
 function extFromName(name: string): string {[m
   const m = name.toLowerCase().match(/\.([a-z0-9]+)$/);[m
   return m ? m[1] : "jpg";[m
 }[m
 [m
[31m-// ky_photos ã®åˆ—åå·®ã‚’å¸å[m
[31m-function pickKind(row: any): string {[m
[31m-  return s(row?.photo_kind).trim() || s(row?.kind).trim() || s(row?.type).trim() || s(row?.category).trim() || "";[m
[31m-}[m
[31m-function pickUrl(row: any): string {[m
[31m-  return ([m
[31m-    s(row?.image_url).trim() ||[m
[31m-    s(row?.photo_url).trim() ||[m
[31m-    s(row?.url).trim() ||[m
[31m-    s(row?.photo_path).trim() ||[m
[31m-    s(row?.path).trim() ||[m
[31m-    ""[m
[31m-  );[m
[31m-}[m
[31m-[m
 function slotSummary(slot: WeatherSlot | null | undefined): string {[m
   if (!slot) return "";[m
   const w = slot.weather_text || "ï¼ˆä¸æ˜ï¼‰";[m
[36m@@ -133,121 +81,11 @@[m [mfunction slotSummary(slot: WeatherSlot | null | undefined): string {[m
   return `${w} / æ°—æ¸©${t} / é¢¨${wd} ${ws} / é™æ°´${p}`;[m
 }[m
 [m
[31m-/** ===== è¡¨ç¤ºç”¨æ•´å½¢ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨åŒã˜ï¼‰ ===== */[m
[31m-[m
[31m-function normalizeLineBase(raw: string): string {[m
[31m-  return raw.replace(/^[â€¢ãƒ»\-*]\s*/, "").replace(/\s+/g, " ").trim();[m
[31m-}[m
[31m-[m
[31m-function stripGenericAccidentNote(x: string): string {[m
[31m-  return x[m
[31m-    .replace(/ï¼ˆ\s*äº‹æ•…ã«ã¤ãªãŒã‚‹æã‚Œ\s*ï¼‰/g, "")[m
[31m-    .replace(/ï¼ˆ\s*äº‹æ•…ã«ç¹‹ãŒã‚‹æã‚Œ\s*ï¼‰/g, "")[m
[31m-    .replace(/ï¼ˆ\s*äº‹æ•…ã«ã¤ãªãŒã‚‹å¯èƒ½æ€§\s*ï¼‰/g, "")[m
[31m-    .replace(/ï¼ˆ\s*äº‹æ•…ã«ç¹‹ãŒã‚‹å¯èƒ½æ€§\s*ï¼‰/g, "")[m
[31m-    .trim();[m
[31m-}[m
[31m-[m
[31m-function takeRightOfArrow(line: string): string {[m
[31m-  const t = line;[m
[31m-  const seps = ["â†’", "â‡’", "->", "ï¼", "ã€‰"];[m
[31m-  for (const sep of seps) {[m
[31m-    const idx = t.indexOf(sep);[m
[31m-    if (idx >= 0) {[m
[31m-      const right = t.slice(idx + sep.length).trim();[m
[31m-      if (right) return right;[m
[31m-    }[m
[31m-  }[m
[31m-  return t.trim();[m
[31m-}[m
[31m-[m
[31m-function dedupeKeepOrder(arr: string[]): string[] {[m
[31m-  const seen = new Set<string>();[m
[31m-  const out: string[] = [];[m
[31m-  for (const x of arr) {[m
[31m-    const k = x.trim();[m
[31m-    if (!k) continue;[m
[31m-    if (seen.has(k)) continue;[m
[31m-    seen.add(k);[m
[31m-    out.push(k);[m
[31m-  }[m
[31m-  return out;[m
[31m-}[m
[31m-[m
[31m-// å±é™ºäºˆçŸ¥ï¼šå³å´ã ã‘æ¡ç”¨ã€(äº‹æ•…ã«ã¤ãªãŒã‚‹æã‚Œ)å‰Šé™¤ã€æœ€å¤§5ä»¶ã€ç•ªå·ãªã—[m
[31m-function formatHazardsForView5(text: string): string[] {[m
[31m-  const lines = String(text ?? "")[m
[31m-    .replace(/\r\n/g, "\n")[m
[31m-    .split("\n")[m
[31m-    .map((x) => x.trim())[m
[31m-    .filter(Boolean);[m
[31m-[m
[31m-  const picked: string[] = [];[m
[31m-  for (const l0 of lines) {[m
[31m-    const base = normalizeLineBase(l0);[m
[31m-    if (!base) continue;[m
[31m-[m
[31m-    let v = takeRightOfArrow(base);[m
[31m-    v = stripGenericAccidentNote(v);[m
[31m-    v = v.replace(/ï¼ˆ\s*[^ï¼‰]*äº‹æ•…[^ï¼‰]*æã‚Œ\s*ï¼‰\s*$/g, "").trim();[m
[31m-[m
[31m-    if (/^å±é™ºäºˆçŸ¥/i.test(v) || /^å¯¾ç­–/i.test(v) || /^AIè£œè¶³/i.test(v)) continue;[m
[31m-    if (v) picked.push(v);[m
[31m-  }[m
[31m-  return dedupeKeepOrder(picked).slice(0, 5);[m
[31m-}[m
[31m-[m
[31m-function splitMeasuresLine(line: string): string[] {[m
[31m-  const t = line.trim();[m
[31m-  const noLead = t.replace(/^\s*\[\s*\d+\s*\]\s*/g, "").replace(/^\s*\d+[)\.]\s*/g, "").trim();[m
[31m-[m
[31m-  const hasMulti = /\[\s*\d+\s*\]/.test(noLead);[m
[31m-  if (!hasMulti) return [noLead];[m
[31m-[m
[31m-  const parts = noLead[m
[31m-    .split(/\[\s*\d+\s*\]/g)[m
[31m-    .map((x) => x.replace(/^[ã€,\s]+/, "").trim())[m
[31m-    .filter(Boolean);[m
[31m-[m
[31m-  return parts.length ? parts : [noLead];[m
[31m-}[m
[31m-[m
[31m-// å¯¾ç­–ï¼šç•ªå·å‰Šé™¤ã€å³å´ã ã‘æ¡ç”¨ã€æœ€å¤§5ä»¶ã€ç•ªå·ãªã—[m
[31m-function formatMeasuresForView5(text: string): string[] {[m
[31m-  const lines = String(text ?? "")[m
[31m-    .replace(/\r\n/g, "\n")[m
[31m-    .split("\n")[m
[31m-    .map((x) => x.trim())[m
[31m-    .filter(Boolean);[m
[31m-[m
[31m-  const items: string[] = [];[m
[31m-  for (const l0 of lines) {[m
[31m-    const base0 = normalizeLineBase(l0);[m
[31m-    if (!base0) continue;[m
[31m-[m
[31m-    const parts = splitMeasuresLine(base0);[m
[31m-    for (let p of parts) {[m
[31m-      p = normalizeLineBase(p);[m
[31m-      if (!p) continue;[m
[31m-[m
[31m-      p = takeRightOfArrow(p);[m
[31m-[m
[31m-      if (/^å¯¾ç­–/i.test(p) || /^AIè£œè¶³/i.test(p)) continue;[m
[31m-      if (p) items.push(p);[m
[31m-    }[m
[31m-  }[m
[31m-  return dedupeKeepOrder(items).slice(0, 5);[m
[32m+[m[32mfunction bulletsFromItemsHazards(items: RiskItem[]) {[m
[32m+[m[32m  return items.map((x) => `ãƒ»${x.hazard}`).join("\n");[m
 }[m
[31m-[m
[31m-// ç¬¬ä¸‰è€…ï¼šç•ªå·ãªã—ï¼ˆä»Šã¯ä¸Šé™ãªã—ï¼‰[m
[31m-function formatThirdForView(text: string): string[] {[m
[31m-  return String(text ?? "")[m
[31m-    .replace(/\r\n/g, "\n")[m
[31m-    .split("\n")[m
[31m-    .map((x) => x.trim())[m
[31m-    .filter(Boolean)[m
[31m-    .map((x) => x.replace(/^[â€¢ãƒ»\-*]\s*/, "").trim())[m
[31m-    .filter(Boolean);[m
[32m+[m[32mfunction bulletsFromItemsMeasures(items: RiskItem[]) {[m
[32m+[m[32m  return items.map((x) => `ãƒ»ï¼ˆ${x.rank}ï¼‰${x.countermeasure}`).join("\n");[m
 }[m
 [m
 export default function KyNewClient() {[m
[36m@@ -274,7 +112,6 @@[m [mexport default function KyNewClient() {[m
   const [partnerCompanyName, setPartnerCompanyName] = useState<string>("");[m
   const [partnerOptions, setPartnerOptions] = useState<PartnerOption[]>([]);[m
 [m
[31m-  // âœ… æœ¬æ—¥ã®ä½œæ¥­å“¡æ•°[m
   const [workerCount, setWorkerCount] = useState<string>("");[m
 [m
   const [workDetail, setWorkDetail] = useState("");[m
[36m@@ -287,32 +124,28 @@[m [mexport default function KyNewClient() {[m
   const [selectedSlotHour, setSelectedSlotHour] = useState<9 | 12 | 15 | null>(null);[m
   const [appliedSlotHour, setAppliedSlotHour] = useState<9 | 12 | 15 | null>(null);[m
 [m
[32m+[m[32m  // å†™çœŸï¼ˆæœ€å°æ§‹æˆï¼‰[m
   const slopeFileRef = useRef<HTMLInputElement | null>(null);[m
   const pathFileRef = useRef<HTMLInputElement | null>(null);[m
[31m-[m
   const [slopeMode, setSlopeMode] = useState<"url" | "file" | "none">("none");[m
   const [pathMode, setPathMode] = useState<"url" | "file" | "none">("none");[m
[31m-[m
   const [slopeFile, setSlopeFile] = useState<File | null>(null);[m
   const [pathFile, setPathFile] = useState<File | null>(null);[m
[31m-[m
   const [slopeFileName, setSlopeFileName] = useState("");[m
   const [pathFileName, setPathFileName] = useState("");[m
[32m+[m[32m  const [slopeNowUrlCached, setSlopeNowUrlCached] = useState<string>("");[m
[32m+[m[32m  const [pathNowUrlCached, setPathNowUrlCached] = useState<string>("");[m
 [m
[31m-  const [slopePrevUrl, setSlopePrevUrl] = useState<string>("");[m
[31m-  const [pathPrevUrl, setPathPrevUrl] = useState<string>("");[m
[32m+[m[32m  // AIï¼ˆæ­£æœ¬ï¼‰[m
[32m+[m[32m  const [aiRiskItems, setAiRiskItems] = useState<RiskItem[]>([]);[m
[32m+[m[32m  const [aiProfile] = useState<"strict" | "normal">("strict");[m
 [m
[31m-  const [aiWork, setAiWork] = useState("");[m
[32m+[m[32m  // äº’æ›ï¼ˆæ—§ã‚«ãƒ©ãƒ ç”¨ï¼‰[m
   const [aiHazards, setAiHazards] = useState("");[m
   const [aiCounter, setAiCounter] = useState("");[m
   const [aiThird, setAiThird] = useState("");[m
[31m-[m
   const [aiGenerating, setAiGenerating] = useState(false);[m
 [m
[31m-  // âœ… AIç”Ÿæˆæ™‚ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã®URLã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆä¿å­˜æ™‚ã®äºŒé‡ã‚¢ãƒƒãƒ—é˜²æ­¢ï¼‰[m
[31m-  const [slopeNowUrlCached, setSlopeNowUrlCached] = useState<string>("");[m
[31m-  const [pathNowUrlCached, setPathNowUrlCached] = useState<string>("");[m
[31m-[m
   const KY_PHOTO_BUCKET = process.env.NEXT_PUBLIC_KY_PHOTO_BUCKET || "ky-photos";[m
 [m
   const slopeUrlFromProject = useMemo(() => s(project?.slope_camera_snapshot_url).trim(), [project?.slope_camera_snapshot_url]);[m
[36m@@ -351,34 +184,9 @@[m [mexport default function KyNewClient() {[m
         }[m
       }[m
 [m
[31m-      const { data: prevPhotos, error: prevErr } = await (supabase as any)[m
[31m-        .from("ky_photos")[m
[31m-        .select("*")[m
[31m-        .eq("project_id", projectId)[m
[31m-        .order("created_at", { ascending: false })[m
[31m-        .limit(50);[m
[31m-[m
[31m-      let prevSlope = "";[m
[31m-      let prevPath = "";[m
[31m-      if (!prevErr && Array.isArray(prevPhotos)) {[m
[31m-        for (const p of prevPhotos) {[m
[31m-          const kind = pickKind(p);[m
[31m-          const url = pickUrl(p);[m
[31m-          if (!url) continue;[m
[31m-[m
[31m-          // âœ… kind=="" ã‚’ä¸¡æ–¹ã«å…¥ã‚Œã‚‹äº‹æ•…ã‚’é¿ã‘ã‚‹ï¼ˆç©ºã¯æ¡ç”¨ã—ãªã„ï¼‰[m
[31m-          if (!prevSlope && (kind === "slope" || kind === "æ³•é¢" || kind === "slope_photo")) prevSlope = url;[m
[31m-          if (!prevPath && (kind === "path" || kind === "é€šè·¯" || kind === "path_photo")) prevPath = url;[m
[31m-[m
[31m-          if (prevSlope && prevPath) break;[m
[31m-        }[m
[31m-      }[m
[31m-[m
       if (mountedRef.current) {[m
         setProject((proj as any) ?? null);[m
         setPartnerOptions(opts);[m
[31m-        setSlopePrevUrl(prevSlope);[m
[31m-        setPathPrevUrl(prevPath);[m
       }[m
     } catch (e: any) {[m
       if (mountedRef.current) setStatus({ type: "error", text: e?.message ?? "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ" });[m
[36m@@ -391,7 +199,7 @@[m [mexport default function KyNewClient() {[m
     fetchInitial();[m
   }, [fetchInitial]);[m
 [m
[31m-  // âœ… weatherï¼šPOSTãŒ405ãªã‚‰GETã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯[m
[32m+[m[32m  // weather[m
   const fetchWeather = useCallback(async () => {[m
     const lat = project?.lat ?? null;[m
     const lon = project?.lon ?? null;[m
[36m@@ -424,13 +232,8 @@[m [mexport default function KyNewClient() {[m
         .sort((a, b) => a.hour - b.hour);[m
 [m
       setWeatherSlots(normalized);[m
[31m-[m
[31m-      if (normalized.length) {[m
[31m-        setSelectedSlotHour(normalized[0].hour);[m
[31m-      } else {[m
[31m-        setSelectedSlotHour(null);[m
[31m-        setAppliedSlotHour(null);[m
[31m-      }[m
[32m+[m[32m      setSelectedSlotHour(normalized.length ? normalized[0].hour : null);[m
[32m+[m[32m      if (!normalized.length) setAppliedSlotHour(null);[m
     } catch {[m
       setWeatherSlots([]);[m
       setSelectedSlotHour(null);[m
[36m@@ -447,7 +250,6 @@[m [mexport default function KyNewClient() {[m
     setAppliedSlotHour(selectedSlotHour);[m
   }, [selectedSlotHour]);[m
 [m
[31m-  // âœ… é©ç”¨æ ã‚’å…ˆé ­ã¸ï¼ˆä¿å­˜ã«ã‚‚ä½¿ã†ï¼‰[m
   const appliedSlots = useMemo(() => {[m
     if (!appliedSlotHour) return weatherSlots;[m
     const arr = [...weatherSlots];[m
[36m@@ -464,6 +266,7 @@[m [mexport default function KyNewClient() {[m
     return weatherSlots.find((x) => x.hour === appliedSlotHour) ?? null;[m
   }, [weatherSlots, appliedSlotHour]);[m
 [m
[32m+[m[32m  // å†™çœŸå…¥åŠ›[m
   const onPickSlopeFile = useCallback(() => slopeFileRef.current?.click(), []);[m
   const onPickPathFile = useCallback(() => pathFileRef.current?.click(), []);[m
 [m
[36m@@ -474,7 +277,7 @@[m [mexport default function KyNewClient() {[m
     setSlopeMode("file");[m
     setSlopeFile(f);[m
     setSlopeFileName(f.name);[m
[31m-    setSlopeNowUrlCached(""); // âœ… åˆ‡ã‚Šæ›¿ãˆãŸã‚‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç ´æ£„[m
[32m+[m[32m    setSlopeNowUrlCached("");[m
   }, []);[m
 [m
   const onPathFileChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {[m
[36m@@ -484,7 +287,7 @@[m [mexport default function KyNewClient() {[m
     setPathMode("file");[m
     setPathFile(f);[m
     setPathFileName(f.name);[m
[31m-    setPathNowUrlCached(""); // âœ… åˆ‡ã‚Šæ›¿ãˆãŸã‚‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç ´æ£„[m
[32m+[m[32m    setPathNowUrlCached("");[m
   }, []);[m
 [m
   const uploadToStorage = useCallback([m
[36m@@ -507,117 +310,55 @@[m [mexport default function KyNewClient() {[m
     [KY_PHOTO_BUCKET, projectId][m
   );[m
 [m
[31m-  const buildAiPayload = useCallback(async () => {[m
[31m-    const w = workDetail.trim();[m
[31m-    if (!w) throw new Error("ä½œæ¥­å†…å®¹ï¼ˆå¿…é ˆï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");[m
[31m-[m
[31m-    let slopeNowUrl: string | null = null;[m
[31m-    let pathNowUrl: string | null = null;[m
[31m-[m
[31m-    // âœ… ã¾ãšã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†[m
[31m-    if (slopeNowUrlCached) slopeNowUrl = slopeNowUrlCached;[m
[31m-    else {[m
[31m-      if (slopeMode === "url") slopeNowUrl = slopeUrlFromProject || null;[m
[31m-      if (slopeMode === "file" && slopeFile) slopeNowUrl = await uploadToStorage(slopeFile, "slope");[m
[31m-    }[m
[31m-[m
[31m-    if (pathNowUrlCached) pathNowUrl = pathNowUrlCached;[m
[31m-    else {[m
[31m-      if (pathMode === "url") pathNowUrl = pathUrlFromProject || null;[m
[31m-      if (pathMode === "file" && pathFile) pathNowUrl = await uploadToStorage(pathFile, "path");[m
[31m-    }[m
[31m-[m
[31m-    // âœ… AIç”Ÿæˆã§ä¸€åº¦ã‚¢ãƒƒãƒ—ã—ãŸURLã¯ä¿å­˜æ™‚ã«ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥[m
[31m-    if (slopeNowUrl) setSlopeNowUrlCached(slopeNowUrl);[m
[31m-    if (pathNowUrl) setPathNowUrlCached(pathNowUrl);[m
[31m-[m
[31m-    const slotsForAi = (appliedSlots || []).map((x) => ({[m
[31m-      hour: x.hour,[m
[31m-      weather_text: x.weather_text,[m
[31m-      temperature_c: x.temperature_c ?? null,[m
[31m-      wind_direction_deg: x.wind_direction_deg ?? null,[m
[31m-      wind_speed_ms: x.wind_speed_ms ?? null,[m
[31m-      precipitation_mm: x.precipitation_mm ?? null,[m
[31m-    }));[m
[31m-[m
[31m-    const lat = project?.lat ?? null;[m
[31m-    const lon = project?.lon ?? null;[m
[31m-[m
[31m-    return {[m
[31m-      work_detail: w,[m
[31m-      hazards: hazards.trim() ? hazards.trim() : null,[m
[31m-      countermeasures: countermeasures.trim() ? countermeasures.trim() : null,[m
[31m-      third_party_level: thirdPartyLevel.trim() ? thirdPartyLevel.trim() : null,[m
[31m-[m
[31m-      worker_count: workerCount.trim() ? Number(workerCount.trim()) : null,[m
[31m-[m
[31m-      lat,[m
[31m-      lon,[m
[31m-[m
[31m-      weather_slots: slotsForAi.length ? slotsForAi : null,[m
[31m-      slope_photo_url: slopeNowUrl,[m
[31m-      slope_prev_photo_url: slopePrevUrl || null,[m
[31m-      path_photo_url: pathNowUrl,[m
[31m-      path_prev_photo_url: pathPrevUrl || null,[m
[31m-    };[m
[31m-  }, [[m
[31m-    workDetail,[m
[31m-    hazards,[m
[31m-    countermeasures,[m
[31m-    thirdPartyLevel,[m
[31m-    workerCount,[m
[31m-    appliedSlots,[m
[31m-    slopeMode,[m
[31m-    pathMode,[m
[31m-    slopeUrlFromProject,[m
[31m-    pathUrlFromProject,[m
[31m-    slopeFile,[m
[31m-    pathFile,[m
[31m-    uploadToStorage,[m
[31m-    slopePrevUrl,[m
[31m-    pathPrevUrl,[m
[31m-    project?.lat,[m
[31m-    project?.lon,[m
[31m-    slopeNowUrlCached,[m
[31m-    pathNowUrlCached,[m
[31m-  ]);[m
[31m-[m
[32m+[m[32m  // âœ… AIç”Ÿæˆï¼šä½œæ¥­å†…å®¹ã‹ã‚‰ï¼ˆChatGPTæ¨è«–ï¼‹ã‚¬ãƒ¼ãƒ‰ï¼‰â†’ ai_risk_items[m
   const onGenerateAi = useCallback(async () => {[m
     setStatus({ type: null, text: "ç”Ÿæˆä¸­..." });[m
     setAiGenerating(true);[m
 [m
     try {[m
[31m-      const payload = await buildAiPayload();[m
[32m+[m[32m      const w = workDetail.trim();[m
[32m+[m[32m      if (!w) throw new Error("ä½œæ¥­å†…å®¹ï¼ˆå¿…é ˆï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");[m
 [m
[31m-      const res = await fetch("/api/ky-ai-supplement", {[m
[32m+[m[32m      const res = await fetch("/api/ky-ai-suggest", {[m
         method: "POST",[m
         headers: { "Content-Type": "application/json" },[m
         cache: "no-store",[m
[31m-        body: JSON.stringify(payload),[m
[32m+[m[32m        body: JSON.stringify({[m
[32m+[m[32m          workContent: w,[m
[32m+[m[32m          hazardsText: hazards || "",[m
[32m+[m[32m          thirdPartyLevel: thirdPartyLevel || "",[m
[32m+[m[32m          profile: aiProfile,[m
[32m+[m[32m        }),[m
       });[m
 [m
       const j = await res.json().catch(() => ({}));[m
       if (!res.ok) throw new Error(j?.error || "AIè£œè¶³ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ");[m
 [m
[31m-      const w = normalizeText(s(j?.ai_work_detail));[m
[31m-      const h = normalizeText(s(j?.ai_hazards));[m
[31m-      const c = normalizeText(s(j?.ai_countermeasures));[m
[31m-      const t = normalizeText(s(j?.ai_third_party));[m
[31m-[m
[31m-      if (w || h || c || t) {[m
[31m-        setAiWork(w);[m
[31m-        setAiHazards(h);[m
[31m-        setAiCounter(c);[m
[31m-        setAiThird(t);[m
[31m-      } else {[m
[31m-        const combined = normalizeText(s(j?.ai_supplement));[m
[31m-        const split = splitAiCombined(combined);[m
[31m-[m
[31m-        setAiWork(normalizeText(split.work));[m
[31m-        setAiHazards(normalizeText(split.hazards));[m
[31m-        setAiCounter(normalizeText(split.countermeasures));[m
[31m-        setAiThird(normalizeText(split.third));[m
[31m-      }[m
[32m+[m[32m      const items = Array.isArray(j?.ai_risk_items) ? (j.ai_risk_items as RiskItem[]) : [];[m
[32m+[m[32m      setAiRiskItems(items);[m
[32m+[m
[32m+[m[32m      // äº’æ›ã‚‚ã‚»ãƒƒãƒˆï¼ˆä¿å­˜ãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼äº’æ›ç”¨ï¼‰[m
[32m+[m[32m      setAiHazards(s(j?.ai_hazards || bulletsFromItemsHazards(items)));[m
[32m+[m[32m      setAiCounter(s(j?.ai_countermeasures || bulletsFromItemsMeasures(items)));[m
[32m+[m
[32m+[m[32m      // ç¬¬ä¸‰è€…ï¼ˆç¾çŠ¶OKã¨ã®ã“ã¨ãªã®ã§ç°¡æ˜“ã§ååˆ†ï¼‰[m
[32m+[m[32m      const third = (() => {[m
[32m+[m[32m        if (thirdPartyLevel === "å¤šã„") {[m
[32m+[m[32m          return [[m
[32m+[m[32m            "ãƒ»èª˜å°å“¡ã‚’é…ç½®ã—ã€å¢“å‚è€…ã®å‹•ç·šã‚’å¸¸æ™‚ç›£è¦–ã™ã‚‹ã“ã¨",[m
[32m+[m[32m            "ãƒ»ä½œæ¥­åŒºç”»ã‚’ã‚³ãƒ¼ãƒ³ãƒ»ãƒãƒ¼ã§æ˜ç¢ºåŒ–ã—ã€ç«‹å…¥è¦åˆ¶ã‚’è¡Œã†ã“ã¨",[m
[32m+[m[32m            "ãƒ»æ¥è¿‘ãŒã‚ã‚Œã°ä½œæ¥­ã‚’ä¸€æ™‚ä¸­æ–­ã—ã€å®‰å…¨ç¢ºä¿å¾Œã«å†é–‹ã™ã‚‹ã“ã¨",[m
[32m+[m[32m          ].join("\n");[m
[32m+[m[32m        }[m
[32m+[m[32m        if (thirdPartyLevel === "å°‘ãªã„") {[m
[32m+[m[32m          return [[m
[32m+[m[32m            "ãƒ»å‡ºå…¥å£ä»˜è¿‘ã«æ³¨æ„å–šèµ·è¡¨ç¤ºã‚’è¡Œã„ã€å£°æ›ã‘ã‚’å¾¹åº•ã™ã‚‹ã“ã¨",[m
[32m+[m[32m            "ãƒ»æ¥è¿‘æ™‚ã¯ä½œæ¥­ã‚’ä¸€æ™‚åœæ­¢ã—ã€èª˜å°ã—ã¦å®‰å…¨ã‚’ç¢ºä¿ã™ã‚‹ã“ã¨",[m
[32m+[m[32m          ].join("\n");[m
[32m+[m[32m        }[m
[32m+[m[32m        return "";[m
[32m+[m[32m      })();[m
[32m+[m[32m      setAiThird(third);[m
 [m
       setStatus({ type: "success", text: "AIè£œè¶³ã‚’ç”Ÿæˆã—ã¾ã—ãŸ" });[m
     } catch (e: any) {[m
[36m@@ -625,8 +366,30 @@[m [mexport default function KyNewClient() {[m
     } finally {[m
       setAiGenerating(false);[m
     }[m
[31m-  }, [buildAiPayload]);[m
[32m+[m[32m  }, [workDetail, hazards, thirdPartyLevel, aiProfile]);[m
[32m+[m
[32m+[m[32m  const WeatherCard = useCallback(({ slot, appliedHour }: { slot: WeatherSlot; appliedHour: 9 | 12 | 15 | null }) => {[m
[32m+[m[32m    const isApplied = appliedHour != null && slot.hour === appliedHour;[m
[32m+[m[32m    return ([m
[32m+[m[32m      <div className={`rounded-lg border p-3 ${isApplied ? "border-emerald-300 bg-emerald-50" : "border-slate-200 bg-slate-50"}`}>[m
[32m+[m[32m        <div className="flex items-center justify-between">[m
[32m+[m[32m          <div className="text-sm font-semibold text-slate-800">{slot.hour}æ™‚</div>[m
[32m+[m[32m          {isApplied && <div className="text-xs font-semibold text-emerald-700">é©ç”¨ä¸­</div>}[m
[32m+[m[32m        </div>[m
[32m+[m[32m        <div className="mt-1 text-sm text-slate-700">{slot.weather_text || "ï¼ˆä¸æ˜ï¼‰"}</div>[m
[32m+[m[32m        <div className="mt-2 text-xs text-slate-600 space-y-1">[m
[32m+[m[32m          <div>æ°—æ¸©ï¼š{slot.temperature_c ?? "â€”"} â„ƒ</div>[m
[32m+[m[32m          <div>[m
[32m+[m[32m            é¢¨ï¼š{degToDirJp(slot.wind_direction_deg) || "â€”"}{" "}[m
[32m+[m[32m            {slot.wind_speed_ms !== null && slot.wind_speed_ms !== undefined ? `${slot.wind_speed_ms} m/s` : "â€”"}[m
[32m+[m[32m          </div>[m
[32m+[m[32m          <div>é™æ°´ï¼š{slot.precipitation_mm ?? "â€”"} mm</div>[m
[32m+[m[32m        </div>[m
[32m+[m[32m      </div>[m
[32m+[m[32m    );[m
[32m+[m[32m  }, []);[m
 [m
[32m+[m[32m  // âœ… ä¿å­˜ï¼š/api/ky-create çµŒç”±ï¼ˆkyIdã‚’å—ã‘å–ã£ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¸ï¼‰[m
   const onSave = useCallback(async () => {[m
     setStatus({ type: null, text: "" });[m
 [m
[36m@@ -641,10 +404,15 @@[m [mexport default function KyNewClient() {[m
 [m
     setSaving(true);[m
     try {[m
[32m+[m[32m      // âœ… session token[m
[32m+[m[32m      const { data: sess } = await supabase.auth.getSession();[m
[32m+[m[32m      const accessToken = s(sess?.session?.access_token).trim();[m
[32m+[m[32m      if (!accessToken) throw new Error("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ï¼ˆaccess tokenãªã—ï¼‰");[m
[32m+[m
[32m+[m[32m      // âœ… å†™çœŸURLç¢ºå®šï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å„ªå…ˆï¼‰[m
       let slopeSavedUrl: string | null = null;[m
       let pathSavedUrl: string | null = null;[m
 [m
[31m-      // âœ… AIç”Ÿæˆã§ã‚¢ãƒƒãƒ—æ¸ˆã¿ãªã‚‰ãã‚Œã‚’ä½¿ã†ï¼ˆé‡è¤‡ã‚¢ãƒƒãƒ—é˜²æ­¢ï¼‰[m
       if (slopeNowUrlCached) slopeSavedUrl = slopeNowUrlCached;[m
       else {[m
         if (slopeMode === "file" && slopeFile) slopeSavedUrl = await uploadToStorage(slopeFile, "slope");[m
[36m@@ -657,45 +425,48 @@[m [mexport default function KyNewClient() {[m
         else if (pathMode === "url") pathSavedUrl = pathUrlFromProject || null;[m
       }[m
 [m
[31m-      const insertPayload: any = {[m
[32m+[m[32m      // âœ… ky-create payloadï¼ˆã‚­ãƒ¼åï¼šwork_contentï¼‰[m
[32m+[m[32m      const createPayload: any = {[m
         project_id: projectId,[m
         work_date: workDate,[m
[31m-        work_detail: workDetail.trim(),[m
[32m+[m[32m        partner_company_name: partnerCompanyName.trim(),[m
[32m+[m
[32m+[m[32m        worker_count: workerCount.trim() ? Number(workerCount.trim()) : null,[m
[32m+[m
[32m+[m[32m        work_content: workDetail.trim(),[m
         hazards: hazards.trim() ? hazards.trim() : null,[m
         countermeasures: countermeasures.trim() ? countermeasures.trim() : null,[m
         third_party_level: thirdPartyLevel.trim() ? thirdPartyLevel.trim() : null,[m
[31m-        partner_company_name: partnerCompanyName.trim(),[m
 [m
[31m-        // âœ… é©ç”¨æ ã‚’å…ˆé ­ã«ã—ãŸä¸¦ã³ã§ä¿å­˜ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã§å…ˆé ­ï¼é©ç”¨æ ã¨ã—ã¦ä½¿ã†ï¼‰[m
         weather_slots: appliedSlots && appliedSlots.length ? appliedSlots : null,[m
 [m
[31m-        worker_count: workerCount.trim() ? Number(workerCount.trim()) : null,[m
[31m-[m
[31m-        // âœ… ä¿å­˜ã¯å£Šã•ãªã„ï¼ˆè¡¨ç¤ºã ã‘å‡ºã•ãªã„ï¼‰[m
[31m-        ai_work_detail: aiWork.trim() ? aiWork.trim() : null,[m
[32m+[m[32m        // AIäº’æ›[m
[32m+[m[32m        ai_work_detail: null,[m
         ai_hazards: aiHazards.trim() ? aiHazards.trim() : null,[m
         ai_countermeasures: aiCounter.trim() ? aiCounter.trim() : null,[m
         ai_third_party: aiThird.trim() ? aiThird.trim() : null,[m
[31m-        ai_supplement: [[m
[31m-          "ã€AIè£œè¶³ï½œä½œæ¥­å†…å®¹ã€‘",[m
[31m-          aiWork.trim(),[m
[31m-          "ã€AIè£œè¶³ï½œå±é™ºäºˆçŸ¥ã€‘",[m
[31m-          aiHazards.trim(),[m
[31m-          "ã€AIè£œè¶³ï½œå¯¾ç­–ã€‘",[m
[31m-          aiCounter.trim(),[m
[31m-          "ã€AIè£œè¶³ï½œç¬¬ä¸‰è€…ã€‘",[m
[31m-          aiThird.trim(),[m
[31m-        ][m
[31m-          .filter(Boolean)[m
[31m-          .join("\n"),[m
[32m+[m
[32m+[m[32m        // âœ… AIæ­£æœ¬[m
[32m+[m[32m        ai_risk_items: aiRiskItems.length ? aiRiskItems.slice(0, 5) : null,[m
[32m+[m[32m        ai_profile: "strict",[m
       };[m
 [m
[31m-      const { data: inserted, error: insErr } = await (supabase as any).from("ky_entries").insert(insertPayload).select("id").maybeSingle();[m
[31m-      if (insErr) throw insErr;[m
[32m+[m[32m      const resp = await fetch("/api/ky-create", {[m
[32m+[m[32m        method: "POST",[m
[32m+[m[32m        headers: {[m
[32m+[m[32m          "Content-Type": "application/json",[m
[32m+[m[32m          Authorization: `Bearer ${accessToken}`,[m
[32m+[m[32m        },[m
[32m+[m[32m        body: JSON.stringify(createPayload),[m
[32m+[m[32m      });[m
[32m+[m
[32m+[m[32m      const jr = await resp.json().catch(() => ({}));[m
[32m+[m[32m      if (!resp.ok) throw new Error(jr?.error || "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");[m
 [m
[31m-      const kyId = s(inserted?.id).trim();[m
[32m+[m[32m      const kyId = s(jr?.kyId).trim();[m
       if (!kyId) throw new Error("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆkyIdä¸æ˜ï¼‰");[m
 [m
[32m+[m[32m      // âœ… ky_photos ã¸ä¿å­˜ï¼ˆæ—¢å­˜é‹ç”¨ï¼‰[m
       const photoRows: any[] = [];[m
       if (slopeSavedUrl) {[m
         photoRows.push({[m
[36m@@ -717,17 +488,14 @@[m [mexport default function KyNewClient() {[m
           photo_url: pathSavedUrl,[m
         });[m
       }[m
[31m-[m
       if (photoRows.length) {[m
         const { error: photoErr } = await (supabase as any).from("ky_photos").insert(photoRows);[m
         if (photoErr) throw photoErr;[m
       }[m
 [m
       setStatus({ type: "success", text: "ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã¸ç§»å‹•ï¼‰" });[m
[31m-[m
       router.push(`/projects/${projectId}/ky/${kyId}/review`);[m
       router.refresh();[m
[31m-      return;[m
     } catch (e: any) {[m
       setStatus({ type: "error", text: e?.message ?? "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ" });[m
     } finally {[m
[36m@@ -742,10 +510,11 @@[m [mexport default function KyNewClient() {[m
     projectId,[m
     workDate,[m
     appliedSlots,[m
[31m-    aiWork,[m
     aiHazards,[m
     aiCounter,[m
     aiThird,[m
[32m+[m[32m    aiRiskItems,[m
[32m+[m[32m    workerCount,[m
     router,[m
     slopeMode,[m
     pathMode,[m
[36m@@ -754,37 +523,10 @@[m [mexport default function KyNewClient() {[m
     uploadToStorage,[m
     slopeUrlFromProject,[m
     pathUrlFromProject,[m
[31m-    workerCount,[m
     slopeNowUrlCached,[m
     pathNowUrlCached,[m
   ]);[m
 [m
[31m-  const WeatherCard = useCallback(({ slot, appliedHour }: { slot: WeatherSlot; appliedHour: 9 | 12 | 15 | null }) => {[m
[31m-    const isApplied = appliedHour != null && slot.hour === appliedHour;[m
[31m-    return ([m
[31m-      <div className={`rounded-lg border p-3 ${isApplied ? "border-emerald-300 bg-emerald-50" : "border-slate-200 bg-slate-50"}`}>[m
[31m-        <div className="flex items-center justify-between">[m
[31m-          <div className="text-sm font-semibold text-slate-800">{slot.hour}æ™‚</div>[m
[31m-          {isApplied && <div className="text-xs font-semibold text-emerald-700">é©ç”¨ä¸­</div>}[m
[31m-        </div>[m
[31m-        <div className="mt-1 text-sm text-slate-700">{slot.weather_text || "ï¼ˆä¸æ˜ï¼‰"}</div>[m
[31m-        <div className="mt-2 text-xs text-slate-600 space-y-1">[m
[31m-          <div>æ°—æ¸©ï¼š{slot.temperature_c ?? "â€”"} â„ƒ</div>[m
[31m-          <div>[m
[31m-            é¢¨ï¼š{degToDirJp(slot.wind_direction_deg) || "â€”"}{" "}[m
[31m-            {slot.wind_speed_ms !== null && slot.wind_speed_ms !== undefined ? `${slot.wind_speed_ms} m/s` : "â€”"}[m
[31m-          </div>[m
[31m-          <div>é™æ°´ï¼š{slot.precipitation_mm ?? "â€”"} mm</div>[m
[31m-        </div>[m
[31m-      </div>[m
[31m-    );[m
[31m-  }, []);[m
[31m-[m
[31m-  // âœ… AIè¡¨ç¤ºï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨åŒã˜ï¼šå±é™ºäºˆçŸ¥/å¯¾ç­–ã¯5ä»¶ãƒ»ç•ªå·ãªã—ãƒ»é‡è¤‡/æ³¨è¨˜é™¤å»ï¼‰[m
[31m-  const aiHazardsTop5 = useMemo(() => formatHazardsForView5(aiHazards), [aiHazards]);[m
[31m-  const aiMeasuresTop5 = useMemo(() => formatMeasuresForView5(aiCounter), [aiCounter]);[m
[31m-  const aiThirdView = useMemo(() => formatThirdForView(aiThird), [aiThird]);[m
[31m-[m
   if (loading) {[m
     return ([m
       <div className="p-4">[m
[36m@@ -810,10 +552,6 @@[m [mexport default function KyNewClient() {[m
         </div>[m
       </div>[m
 [m
[31m-      <div className="rounded-lg border border-rose-200 bg-rose-50 px-3 py-2 text-sm text-rose-800">[m
[31m-        å·¥äº‹æƒ…å ±ç·¨é›†ã§ã€Œé€šè·¯ï¼ˆå®šç‚¹ï¼‰åœæ­¢ç”»URLã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæœªè¨­ç½®ãªã‚‰ç©ºæ¬„OKï¼‰[m
[31m-      </div>[m
[31m-[m
       <div className="rounded-xl border border-slate-200 bg-white p-4 space-y-2">[m
         <div className="text-sm font-semibold text-slate-800">æ–½å·¥ä¼šç¤¾ï¼ˆå›ºå®šï¼‰</div>[m
         <div className="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-800">[m
[36m@@ -922,7 +660,7 @@[m [mexport default function KyNewClient() {[m
             onChange={(e) => setWorkDetail(e.target.value)}[m
             rows={3}[m
             className="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm"[m
[31m-            placeholder="ä¾‹ï¼šæ³•é¢æ•´å½¢ã€è»¢åœ§ã€åœŸç ‚é‹æ¬ ãªã©"[m
[32m+[m[32m            placeholder="ä¾‹ï¼šèˆ—è£…å·¥ï¼ˆè¡¨å±¤å·¥ ã‚¢ã‚¹ãƒ•ã‚¡ãƒ«ãƒˆèˆ—è¨­ï¼‰ãªã©"[m
           />[m
         </div>[m
 [m
[36m@@ -947,7 +685,50 @@[m [mexport default function KyNewClient() {[m
         <div className="text-xs text-slate-500">â€» å¢“å‚è€…ã®å¤šå°‘ã«å¿œã˜ã¦ã€èª˜å°ãƒ»åŒºç”»åˆ†é›¢ãƒ»å£°æ›ã‘ç­‰ã‚’AIè£œè¶³ã«åæ˜ ã—ã¾ã™ã€‚</div>[m
       </div>[m
 [m
[31m-      {/* ---ï¼ˆä¸­ç•¥ï¼šå†™çœŸãƒ–ãƒ­ãƒƒã‚¯ã¯å…ƒã®ã¾ã¾ï¼‰--- */}[m
[32m+[m[32m      {/* å†™çœŸï¼ˆæœ€å°ï¼šURL or ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ */}[m
[32m+[m[32m      <div className="rounded-xl border border-slate-200 bg-white p-4 space-y-3">[m
[32m+[m[32m        <div className="text-sm font-semibold text-slate-800">å†™çœŸï¼ˆä»»æ„ï¼‰</div>[m
[32m+[m
[32m+[m[32m        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">[m
[32m+[m[32m          <div className="space-y-2">[m
[32m+[m[32m            <div className="text-xs text-slate-600">æ³•é¢ï¼ˆä»Šå›ï¼‰</div>[m
[32m+[m[32m            <div className="flex gap-2 flex-wrap">[m
[32m+[m[32m              <button type="button" onClick={() => { setSlopeMode("url"); setSlopeFile(null); setSlopeFileName(""); }} className="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm hover:bg-slate-50">[m
[32m+[m[32m                å®šç‚¹URLã‚’ä½¿ã†[m
[32m+[m[32m              </button>[m
[32m+[m[32m              <button type="button" onClick={onPickSlopeFile} className="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm hover:bg-slate-50">[m
[32m+[m[32m                ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ[m
[32m+[m[32m              </button>[m
[32m+[m[32m              <button type="button" onClick={() => { setSlopeMode("none"); setSlopeFile(null); setSlopeFileName(""); setSlopeNowUrlCached(""); }} className="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm hover:bg-slate-50">[m
[32m+[m[32m                ãªã—[m
[32m+[m[32m              </button>[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div className="text-xs text-slate-500">[m
[32m+[m[32m              {slopeMode === "url" ? `URLï¼š${slopeUrlFromProject || "ï¼ˆæœªè¨­å®šï¼‰"}` : slopeMode === "file" ? `ãƒ•ã‚¡ã‚¤ãƒ«ï¼š${slopeFileName}` : "ï¼ˆãªã—ï¼‰"}[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <input ref={slopeFileRef} type="file" accept="image/*" className="hidden" onChange={onSlopeFileChange} />[m
[32m+[m[32m          </div>[m
[32m+[m
[32m+[m[32m          <div className="space-y-2">[m
[32m+[m[32m            <div className="text-xs text-slate-600">é€šè·¯ï¼ˆä»Šå›ï¼‰</div>[m
[32m+[m[32m            <div className="flex gap-2 flex-wrap">[m
[32m+[m[32m              <button type="button" onClick={() => { setPathMode("url"); setPathFile(null); setPathFileName(""); }} className="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm hover:bg-slate-50">[m
[32m+[m[32m                å®šç‚¹URLã‚’ä½¿ã†[m
[32m+[m[32m              </button>[m
[32m+[m[32m              <button type="button" onClick={onPickPathFile} className="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm hover:bg-slate-50">[m
[32m+[m[32m                ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ[m
[32m+[m[32m              </button>[m
[32m+[m[32m              <button type="button" onClick={() => { setPathMode("none"); setPathFile(null); setPathFileName(""); setPathNowUrlCached(""); }} className="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm hover:bg-slate-50">[m
[32m+[m[32m                ãªã—[m
[32m+[m[32m              </button>[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div className="text-xs text-slate-500">[m
[32m+[m[32m              {pathMode === "url" ? `URLï¼š${pathUrlFromProject || "ï¼ˆæœªè¨­å®šï¼‰"}` : pathMode === "file" ? `ãƒ•ã‚¡ã‚¤ãƒ«ï¼š${pathFileName}` : "ï¼ˆãªã—ï¼‰"}[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <input ref={pathFileRef} type="file" accept="image/*" className="hidden" onChange={onPathFileChange} />[m
[32m+[m[32m          </div>[m
[32m+[m[32m        </div>[m
[32m+[m[32m      </div>[m
 [m
       <div className="rounded-xl border border-slate-200 bg-white p-4 space-y-3">[m
         <div className="flex items-center justify-between gap-3">[m
[36m@@ -962,61 +743,50 @@[m [mexport default function KyNewClient() {[m
           </button>[m
         </div>[m
 [m
[31m-        {/* âœ… ä½œæ¥­å†…å®¹ã®è£œè¶³ã¯è¡¨ç¤ºã—ãªã„ï¼ˆäººã®å…¥åŠ›ãŒæ­£ï¼‰ */}[m
[31m-        {/* <div className="space-y-2">[m
[31m-          <div className="text-xs text-slate-600">ä½œæ¥­å†…å®¹ã®è£œè¶³</div>[m
[31m-          <textarea value={aiWork} onChange={(e) => setAiWork(e.target.value)} rows={4} className="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm" />[m
[31m-        </div> */}[m
[32m+[m[32m        {/* âœ… ä½œæ¥­å†…å®¹ã®è£œè¶³ã¯ä¸è¦ï¼ˆäººå…¥åŠ›ãŒæ­£ï¼‰ */}[m
 [m
         <div className="space-y-2">[m
[31m-          <div className="text-xs text-slate-600">å±é™ºäºˆçŸ¥ã®è£œè¶³ï¼ˆä¸Šä½5é …ç›®ãƒ»ç•ªå·ãªã—ï¼‰</div>[m
[31m-          {aiHazardsTop5.length ? ([m
[32m+[m[32m          <div className="text-xs text-slate-600">å±é™ºäºˆçŸ¥ã®è£œè¶³ï¼ˆä¸Šä½5ãƒ»ãƒªã‚¹ã‚¯é †ï¼‰</div>[m
[32m+[m[32m          {aiRiskItems.length ? ([m
             <div className="rounded-lg border border-slate-300 bg-white p-3">[m
               <ul className="list-disc pl-5 text-sm text-slate-800 space-y-1">[m
[31m-                {aiHazardsTop5.map((x, i) => ([m
[31m-                  <li key={`${x}-${i}`}>{x}</li>[m
[32m+[m[32m                {aiRiskItems.slice(0, 5).map((x) => ([m
[32m+[m[32m                  <li key={`h-${x.rank}`}>{x.hazard}</li>[m
                 ))}[m
               </ul>[m
             </div>[m
           ) : ([m
             <div className="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-600">ï¼ˆãªã—ï¼‰</div>[m
           )}[m
[31m-[m
[31m-          {/* âœ… äºŒé‡è¡¨ç¤ºã®åŸå› ï¼šä¸‹ã®textareaï¼ˆå…ƒãƒ†ã‚­ã‚¹ãƒˆï¼‰ã¯å‰Šé™¤ */}[m
         </div>[m
 [m
         <div className="space-y-2">[m
[31m-          <div className="text-xs text-slate-600">å¯¾ç­–ã®è£œè¶³ï¼ˆä¸Šä½5é …ç›®ãƒ»ç•ªå·ãªã—ï¼‰</div>[m
[31m-          {aiMeasuresTop5.length ? ([m
[32m+[m[32m          <div className="text-xs text-slate-600">å¯¾ç­–ã®è£œè¶³ï¼ˆå±é™ºäºˆçŸ¥ã«å¯¾å¿œï¼š1å¯¾1ï¼‰</div>[m
[32m+[m[32m          {aiRiskItems.length ? ([m
             <div className="rounded-lg border border-slate-300 bg-white p-3">[m
               <ul className="list-disc pl-5 text-sm text-slate-800 space-y-1">[m
[31m-                {aiMeasuresTop5.map((x, i) => ([m
[31m-                  <li key={`${x}-${i}`}>{x}</li>[m
[32m+[m[32m                {aiRiskItems.slice(0, 5).map((x) => ([m
[32m+[m[32m                  <li key={`m-${x.rank}`}>[m
[32m+[m[32m                    <span className="font-semibold">ï¼ˆ{x.rank}ï¼‰</span>[m
[32m+[m[32m                    {x.countermeasure}[m
[32m+[m[32m                  </li>[m
                 ))}[m
               </ul>[m
             </div>[m
           ) : ([m
             <div className="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-600">ï¼ˆãªã—ï¼‰</div>[m
           )}[m
[31m-[m
[31m-          {/* âœ… äºŒé‡è¡¨ç¤ºã®åŸå› ï¼šä¸‹ã®textareaï¼ˆå…ƒãƒ†ã‚­ã‚¹ãƒˆï¼‰ã¯å‰Šé™¤ */}[m
         </div>[m
 [m
         <div className="space-y-2">[m
[31m-          <div className="text-xs text-slate-600">ç¬¬ä¸‰è€…ï¼ˆå¢“å‚è€…ï¼‰ã®è£œè¶³ï¼ˆç•ªå·ãªã—ï¼‰</div>[m
[31m-          {aiThirdView.length ? ([m
[32m+[m[32m          <div className="text-xs text-slate-600">ç¬¬ä¸‰è€…ï¼ˆå¢“å‚è€…ï¼‰ã®è£œè¶³</div>[m
[32m+[m[32m          {aiThird.trim() ? ([m
             <div className="rounded-lg border border-slate-300 bg-white p-3">[m
[31m-              <ul className="list-disc pl-5 text-sm text-slate-800 space-y-1">[m
[31m-                {aiThirdView.map((x, i) => ([m
[31m-                  <li key={`${x}-${i}`}>{x}</li>[m
[31m-                ))}[m
[31m-              </ul>[m
[32m+[m[32m              <pre className="whitespace-pre-wrap text-sm text-slate-800">{aiThird}</pre>[m
             </div>[m
           ) : ([m
             <div className="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-600">ï¼ˆãªã—ï¼‰</div>[m
           )}[m
[31m-[m
[31m-          {/* âœ… äºŒé‡è¡¨ç¤ºã®åŸå› ï¼šä¸‹ã®textareaï¼ˆå…ƒãƒ†ã‚­ã‚¹ãƒˆï¼‰ã¯å‰Šé™¤ */}[m
         </div>[m
       </div>[m
 [m
